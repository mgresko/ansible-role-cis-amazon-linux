

# 5.1.1 Ensure cron daemon is enabled

- name: 5.1.1 - Ensure cron is installed
  yum:
    name: cronie
    state: present
  when: amzn_cis_rule_5_1_1
  tags:
    - level-1
    - section-5
    - "5.1.1"
    - scored

- name: 5.1.1 - Ensure cron daemon is enabled
  service:
    name: "crond"
    enabled: true
    state: started
  ignore_errors: false
  when: amzn_cis_rule_5_1_1
  tags:
    - level-1
    - section-5
    - "5.1.1"
    - scored



# 5.1.2 Ensure permissions on /etc/crontab are configured

- name: 5.1.2 - Ensure permissions on /etc/crontab are configured
  file:
    path: "/etc/crontab"
    owner: root
    group: root
    mode: 0600
  when: amzn_cis_rule_5_1_2
  tags:
    - level-1
    - section-5
    - "5.1.2"
    - scored



# 5.1.3 Ensure permissions on /etc/cron.hourly are configured

- name: 5.1.3 - Ensure permissions on /etc/cron.hourly are configured
  file:
    path: "/etc/cron.hourly"
    owner: root
    group: root
    mode: 0700
  when: amzn_cis_rule_5_1_3
  tags:
    - level-1
    - section-5
    - "5.1.3"
    - scored



# 5.1.4 Ensure permissions on /etc/cron.daily are configured

- name: 5.1.4 - Ensure permissions on /etc/cron.daily are configured
  file:
    path: "/etc/cron.daily"
    owner: root
    group: root
    mode: 0700
  when: amzn_cis_rule_5_1_4
  tags:
    - level-1
    - section-5
    - "5.1.4"
    - scored



# 5.1.5 Ensure permissions on /etc/cron.weekly are configured

- name: 5.1.5 - Ensure permissions on /etc/cron.weekly are configured
  file:
    path: "/etc/cron.weekly"
    owner: root
    group: root
    mode: 0700
  when: amzn_cis_rule_5_1_5
  tags:
    - level-1
    - section-5
    - "5.1.5"
    - scored



# 5.1.6 Ensure permissions on /etc/cron.monthly are configured

- name: 5.1.6 - Ensure permissions on /etc/cron.monthly are configured
  file:
    path: "/etc/cron.monthly"
    owner: root
    group: root
    mode: 0700
  when: amzn_cis_rule_5_1_6
  tags:
    - level-1
    - section-6
    - "5.1.6"
    - scored



# 5.1.7 Ensure permissions on /etc/cron.d are configured

- name: 5.1.7 - Ensure permissions on /etc/cron.d are configured
  file:
    path: "/etc/cron.d"
    owner: root
    group: root
    mode: 0700
    state: directory
  when: amzn_cis_rule_5_1_7
  tags:
    - level-1
    - section-5
    - "5.1.7"
    - scored



# 5.1.8 Ensure at/cron is restricted to authorized users

- name: 5.1.8 - Ensure /etc/cron.deny and /etc/at.deny do not exist
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - "/etc/at.deny"
    - "/etc/cron.deny"
  when: amzn_cis_rule_5_1_8
  tags:
    - level-1
    - section-5
    - "5.1.8"
    - scored

- name: 5.1.8 -  Ensure at/cron is restricted to authorized users
  file:
    path: "{{ item }}"
    state: touch
    owner: root
    group: root
    mode: 0600
  when: amzn_cis_rule_5_1_8
  with_items:
    - "/etc/cron.allow"
    - "/etc/at.allow"
  tags:
    - level-1
    - section-5
    - "5.1.8"
    - scored



# 5.2.1 Ensure permissions on /etc/ssh/sshd_config are configured

- include: stat_sshd_config.yml
  tags:
    - level-1
    - section-5
    - "5.2.1"
    - scored

- name: 5.2.1 - Ensure permissions on /etc/ssh/sshd_config are configured
  file:
    path: /etc/ssh/sshd_config
    owner: root
    group: root
    mode: 0600
  when: sshd_config.stat.exists and amzn_cis_rule_5_2_1
  tags:
    - level-1
    - section-5
    - "5.2.1"
    - scored



# 5.2.10 - Ensure SSH PermitUserEnvironment is disabled

- include: stat_sshd_config.yml
  tags:
    - level-1
    - section-5
    - "5.2.10"
    - scored

- name: 5.2.10 - Ensure SSH PermitUserEnvironment is disabled
  lineinfile:
    regexp: "^PermitUserEnvironment\\s+"
    line: "PermitUserEnvironment no"
    dest: "/etc/ssh/sshd_config"
  when: sshd_config.stat.exists and amzn_cis_rule_5_2_10
  notify:
    - Restart sshd
  tags:
    - level-1
    - section-5
    - "5.2.10"
    - scored



# 5.2.11 - Ensure only approved ciphers are used

- include: stat_sshd_config.yml
  tags:
    - level-1
    - section-5
    - "5.2.11"
    - scored

- name: 5.2.11 - Ensure only approved ciphers are used
  lineinfile:
    regexp: "^Ciphers\\s+"
    line: "Ciphers {{ cis_sshd_ciphers }}"
    dest: "/etc/ssh/sshd_config"
  when: sshd_config.stat.exists and amzn_cis_rule_5_2_11
  notify:
    - Restart sshd
  tags:
    - level-1
    - section-5
    - "5.2.11"
    - scored



# 5.2.12 - Ensure only approved MAC algorithms are used

- include: stat_sshd_config.yml
  tags:
    - level-1
    - section-5
    - "5.2.12"
    - scored

- name: 5.2.12 - Ensure only approved MAC algorithms are used
  lineinfile:
    regexp: "^MACs\\s+"
    line: "MACs {{ cis_sshd_macs }}"
    dest: "/etc/ssh/sshd_config"
  when: sshd_config.stat.exists and amzn_cis_rule_5_2_12
  notify:
    - Restart sshd
  tags:
    - level-1
    - section-5
    - "5.2.12"
    - scored



# 5.2.13 - Ensure SSH Idle Timeout Interval is configured

- include: stat_sshd_config.yml
  tags:
    - level-1
    - section-5
    - "5.2.13"
    - scored

- name: 5.2.13 - Ensure SSH Client Alive Interval is configured
  lineinfile:
    regexp: "^ClientAliveInterval\\s+"
    line: "ClientAliveInterval {{ cis_sshd_client_alive_interval }}"
    dest: "/etc/ssh/sshd_config"
  when: sshd_config.stat.exists and amzn_cis_rule_5_2_13
  notify:
    - Restart sshd
  tags:
    - level-1
    - section-5
    - "5.2.13"
    - scored

- name: 5.2.13 - Ensure SSH Client Alive Count Max is configured
  lineinfile:
    regexp: "^ClientAliveCountMax\\s+"
    line: "ClientAliveCountMax {{ cis_sshd_client_alive_count_max }}"
    dest: "/etc/ssh/sshd_config"
  when: sshd_config.stat.exists and amzn_cis_rule_5_2_13
  notify:
    - Restart sshd
  tags:
    - level-1
    - section-5
    - "5.2.13"
    - scored



# 5.2.14 - Ensure SSH LoginGraceTime is set to one minute or less

- include: stat_sshd_config.yml
  tags:
    - level-1
    - section-5
    - "5.2.14"
    - scored

- name: 5.2.14 - Ensure SSH LoginGraceTime is set to one minute or less
  lineinfile:
    regexp: "^LoginGraceTime\\s+"
    line: "LoginGraceTime {{ cis_sshd_login_grace_time }}"
    dest: "/etc/ssh/sshd_config"
  when: sshd_config.stat.exists and amzn_cis_rule_5_2_14
  notify:
    - Restart sshd
  tags:
    - level-1
    - section-5
    - "5.2.14"
    - scored



# 5.2.15 Ensure SSH access is limited

- include: stat_sshd_config.yml
  tags:
    - level-1
    - section-5
    - "5.2.15"
    - scored

- name: 5.2.15 - Configure SSH AllowUsers
  lineinfile:
    regexp: "^#?AllowUsers\\s+"
    line: "AllowUsers {{ cis_sshd_allow_users }}"
    dest: "/etc/ssh/sshd_config"
  when:
    - sshd_config.stat.exists
    - cis_sshd_allow_users is defined and cis_sshd_allow_users|trim != ""
    - amzn_cis_rule_5_2_15
  notify: Restart sshd
  tags:
    - level-1
    - section-5
    - "5.2.15"
    - scored

- name: 5.2.15 - Configure SSH AllowGroups
  lineinfile:
    regexp: "^#?AllowGroups\\s+"
    line: "AllowGroups {{ cis_sshd_allow_groups }}"
    dest: "/etc/ssh/sshd_config"
  when:
    - sshd_config.stat.exists
    - cis_sshd_allow_groups is defined and cis_sshd_allow_groups|trim != ""
    - amzn_cis_rule_5_2_15
  notify: Restart sshd
  tags:
    - level-1
    - section-5
    - "5.2.15"
    - scored

- name: 5.2.15 - Configure SSH DenyUsers
  lineinfile:
    regexp: "^#?DenyUsers\\s+"
    line: "DenyUsers {{ cis_sshd_deny_users }}"
    dest: "/etc/ssh/sshd_config"
  when:
    - sshd_config.stat.exists
    - cis_sshd_deny_users is defined and cis_sshd_deny_users|trim != ""
    - amzn_cis_rule_5_2_15
  notify: Restart sshd
  tags:
    - level-1
    - section-5
    - "5.2.15"
    - scored

- name: 5.2.15 - Configure SSH DenyGroups
  lineinfile:
    regexp: "^#?DenyGroups\\s+"
    line: "DenyGroups {{ cis_sshd_deny_groups }}"
    dest: "/etc/ssh/sshd_config"
  when:
    - sshd_config.stat.exists
    - cis_sshd_deny_groups is defined and cis_sshd_deny_groups|trim != ""
    - amzn_cis_rule_5_2_15
  notify: Restart sshd
  tags:
    - level-1
    - section-5
    - "5.2.15"
    - scored



# 5.2.16 - Ensure SSH warning banner is configured

- include: stat_sshd_config.yml
  tags:
    - level-1
    - section-5
    - "5.2.16"
    - scored

- name: 5.2.16 - Ensure SSH warning banner is configured
  lineinfile:
    regexp: "^Banner\\s+"
    line: "Banner {{ cis_sshd_banner }}"
    dest: "/etc/ssh/sshd_config"
  when: sshd_config.stat.exists and amzn_cis_rule_5_2_16
  notify:
    - Restart sshd
  tags:
    - level-1
    - section-5
    - "5.2.16"
    - scored



# 5.2.2 - Ensure SSH Protocol is set to 2

- include: stat_sshd_config.yml
  tags:
    - level-1
    - section-5
    - "5.2.2"
    - scored

- name: 5.2.2 - Ensure SSH Protocol is set to 2
  lineinfile:
    regexp: "^Protocol\\s+"
    line: "Protocol 2"
    dest: "/etc/ssh/sshd_config"
  notify: "Restart sshd"
  when: sshd_config.stat.exists and amzn_cis_rule_5_2_2
  tags:
    - level-1
    - section-5
    - "5.2.2"
    - scored



# 5.2.3 - Ensure SSH LogLevel is set to INFO

- include: stat_sshd_config.yml
  tags:
    - level-1
    - section-5
    - "5.2.3"
    - scored

- name: 5.2.3 - Ensure SSH LogLevel is set to INFO
  lineinfile:
    regexp: "^LogLevel\\s+"
    line: "LogLevel INFO"
    dest: "/etc/ssh/sshd_config"
  when: sshd_config.stat.exists and amzn_cis_rule_5_2_3
  notify:
    - Restart sshd
  tags:
    - level-1
    - section-5
    - "5.2.3"
    - scored



# 5.2.4 - Ensure SSH X11 forwarding is disabled

- include: stat_sshd_config.yml
  tags:
    - level-1
    - section-5
    - "5.2.4"
    - scored

- name: 5.2.4 - Ensure SSH X11 forwarding is disabled
  lineinfile:
    regexp: "^X11Forwarding\\s+"
    line: "X11Forwarding no"
    dest: "/etc/ssh/sshd_config"
  when: sshd_config.stat.exists and amzn_cis_rule_5_2_4
  notify:
    - Restart sshd
  tags:
    - level-1
    - section-5
    - "5.2.4"
    - scored



# 5.2.5 -  Ensure SSH MaxAuthTries is set to 4 or less

- include: stat_sshd_config.yml
  tags:
    - level-1
    - section-5
    - "5.2.5"
    - scored

- name: 5.2.5 - Ensure SSH MaxAuthTries is set to 4 or less
  lineinfile:
    regexp: "^MaxAuthTries\\s+"
    line: "MaxAuthTries {{ cis_sshd_max_auth_tries }}"
    dest: "/etc/ssh/sshd_config"
  when: sshd_config.stat.exists and amzn_cis_rule_5_2_5
  notify:
    - Restart sshd
  tags:
    - level-1
    - section-5
    - "5.2.5"
    - scored



# 5.2.6 - Ensure SSH IgnoreRhosts is enabled

- include: stat_sshd_config.yml
  tags:
    - level-1
    - section-5
    - "5.2.6"
    - scored

- name: 5.2.6 - Ensure SSH IgnoreRhosts is enabled
  lineinfile:
    regexp: "^IgnoreRhosts\\s+"
    line: "IgnoreRhosts yes"
    dest: "/etc/ssh/sshd_config"
  when: sshd_config.stat.exists and amzn_cis_rule_5_2_6
  notify:
    - Restart sshd
  tags:
    - level-1
    - section-5
    - "5.2.6"
    - scored



# 5.2.7 - Ensure SSH HostbasedAuthentication is disabled

- include: stat_sshd_config.yml
  tags:
    - level-1
    - section-5
    - "5.2.7"
    - scored

- name: 5.2.7 - Ensure SSH HostbasedAuthentication is disabled
  lineinfile:
    regexp: "^HostbasedAuthentication\\s+"
    line: "HostbasedAuthentication no"
    dest: "/etc/ssh/sshd_config"
  when: sshd_config.stat.exists and amzn_cis_rule_5_2_7
  notify:
    - Restart sshd
  tags:
    - level-1
    - section-5
    - "5.2.7"
    - scored



# 5.2.8 - Ensure SSH root login is disabled

- include: stat_sshd_config.yml
  tags:
    - level-1
    - section-5
    - "5.2.8"
    - scored

- name: 5.2.8 - Ensure SSH root login is disabled
  lineinfile:
    regexp: "^PermitRootLogin\\s+"
    line: "PermitRootLogin no"
    dest: "/etc/ssh/sshd_config"
  when: sshd_config.stat.exists and amzn_cis_rule_5_2_8
  notify:
    - Restart sshd
  tags:
    - level-1
    - section-5
    - "5.2.8"
    - scored



# 5.2.9 - Ensure SSH PermitEmptyPasswords is disabled

- include: stat_sshd_config.yml
  tags:
    - level-1
    - section-5
    - "5.2.9"
    - scored

- name: 5.2.9 - Ensure SSH PermitEmptyPasswords is disabled
  lineinfile:
    regexp: "^PermitEmptyPasswords\\s+"
    line: "PermitEmptyPasswords no"
    dest: "/etc/ssh/sshd_config"
  when: sshd_config.stat.exists and amzn_cis_rule_5_2_9
  notify:
    - Restart sshd
  tags:
    - level-1
    - section-5
    - "5.2.9"
    - scored



# 5.3.1 Ensure password creation requirements are configured

- name: 5.3.1 - Ensure password creation requirements are configured
  lineinfile:
    dest: "/etc/security/pwquality.conf"
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
    create: yes
  with_items:
    - { regexp: "^#?minlen=", line: "minlen={{ cis_pwquality_minlen }}" }
    - { regexp: "^#?dcredit=", line: "dcredit={{ cis_pwquality_dcredit }}" }
    - { regexp: "^#?ucredit=", line: "ucredit={{ cis_pwquality_ucredit }}" }
    - { regexp: "^#?ocredit=", line: "ocredit={{ cis_pwquality_ocredit }}" }
    - { regexp: "^#?lcredit=", line: "lcredit={{ cis_pwquality_lcredit }}" }
  when: amzn_cis_rule_5_3_1
  tags:
    - level-1
    - section-5
    - "5.3.1"
    - scored



# 5.3.2 Ensure lockout for failed password attempts is configured

- name: 5.3.2 - Ensure lockout for failed password attempts is configured(pam_faillock.so - before)
  pamd:
    name: system-auth
    type: auth
    control: sufficient
    module_path: pam_unix.so
    new_type: auth
    new_control: required
    new_module_path: pam_faillock.so
    module_arguments: 'preauth
        audit
        silent
        deny=5
        unlock_time=900'
    state: before
  when: amzn_cis_rule_5_3_2
  tags:
    - level-1
    - section-5
    - "5.3.2"
    - scored

- name: 5.3.2 - Ensure lockout for failed password attempts is configured(pam_faillock.so - last)
  pamd:
    name: system-auth
    type: auth
    control: sufficient
    module_path: pam_unix.so
    new_type: auth
    new_control: sufficient
    new_module_path: pam_faillock.so
    module_arguments: 'authsucc
        audit
        deny=5
        unlock_time=900'
    state: after
  when: amzn_cis_rule_5_3_2
  tags:
    - level-1
    - section-5
    - "5.3.2"
    - scored

- name: 5.3.2 - Ensure lockout for failed password attempts is configured(pam_faillock.so - after)
  pamd:
    name: system-auth
    type: auth
    control: sufficient
    module_path: pam_unix.so
    new_type: auth
    new_control: "[default=die]"
    new_module_path: pam_faillock.so
    module_arguments: 'authfail
        audit
        deny=5
        unlock_time=900'
    state: after
  when: amzn_cis_rule_5_3_2
  tags:
    - level-1
    - section-5
    - "5.3.2"
    - scored

- name: 5.3.2 - Ensure lockout for failed password attempts is configured(pam_unix.so)
  pamd:
    name: system-auth
    type: auth
    control: sufficient
    module_path: pam_unix.so
    new_control: '[success=1 default=bad]'
    module_arguments: ''
    state: updated
  when: amzn_cis_rule_5_3_2
  tags:
    - level-1
    - section-5
    - "5.3.2"
    - scored



# 5.3.3 Ensure password reuse is limited
- name: 5.3.3 - Ensure password reuse is limited (/etc/pam.d/system-auth)
  pamd:
    name: system-auth
    type: password
    control: sufficient
    module_path: pam_unix.so
    new_control: sufficient
    module_arguments: 'remember=5'
    state: updated
  when: amzn_cis_rule_5_3_3
  tags:
    - level-1
    - section-5
    - "5.3.3"
    - scored

- name: 5.3.3 - Ensure password reuse is limited (/etc/pam.d/password-auth)
  pamd:
    name: password-auth
    type: password
    control: sufficient
    module_path: pam_unix.so
    new_control: sufficient
    module_arguments: 'remember=5'
    state: updated
  when: amzn_cis_rule_5_3_3
  tags:
    - level-1
    - section-5
    - "5.3.3"
    - scored



# 5.3.4 Ensure password hashing algorithm is SHA-512

- name: 5.3.4 - Ensure password hashing algorithm is SHA-512
  command: "authconfig --update --passalgo=sha512"
  when: amzn_cis_rule_5_3_4
  tags:
    - level-1
    - section-5
    - "5.3.4"
    - scored



# 5.4.1.1 Ensure password expiration is 90 days or less

- name: 5.4.1.1 - Obtain a list of user accounts
  shell: "egrep ^[^:]+:[^\\!*] /etc/shadow | cut -d: -f1"
  register: egrep_5_4_1_1
  check_mode: no
  changed_when: False
  tags:
    - level-1
    - section-5
    - "5.4.1.1"
    - scored

- name: 5.4.1.1 - Ensure password expiration is 90 days or less
  lineinfile:
    dest: "/etc/login.defs"
    regexp: "^PASS_MAX_DAYS\\s+"
    line: "PASS_MAX_DAYS {{ cis_pass_max_days }}"
  when: amzn_cis_rule_5_4_1_1
  tags:
    - level-1
    - section-5
    - "5.4.1.1"
    - scored

- name: 5.4.1.1 - Set password expiration for all user accounts
  command: "chage --maxdays {{ cis_pass_max_days }} {{ item }}"
  with_items: "{{ egrep_5_4_1_1.stdout_lines }}"
  when: amzn_cis_rule_5_4_1_1
  tags:
    - level-1
    - section-5
    - "5.4.1.1"
    - scored



# 5.4.1.2 Ensure minimum days between password changes is 7 or more

- name: 5.4.1.2 - Obtain a list of user accounts
  shell: "egrep ^[^:]+:[^\\!*] /etc/shadow | cut -d: -f1"
  register: egrep_5_4_1_2
  check_mode: no
  changed_when: False
  tags:
    - level-1
    - section-5
    - "5.4.1.2"
    - scored

- name: 5.4.1.2 - Ensure minimum days between password changes is 7 or more
  lineinfile:
    dest: "/etc/login.defs"
    regexp: "^PASS_MIN_DAYS\\s+"
    line: "PASS_MIN_DAYS {{ cis_pass_min_days }}"
  when: amzn_cis_rule_5_4_1_2
  tags:
    - level-1
    - section-5
    - "5.4.1.2"
    - scored

- name: 5.4.1.2 - Set minimum password change interval for all user accounts
  command: "chage --mindays {{ cis_pass_min_days }} {{ item }}"
  with_items: "{{ egrep_5_4_1_2.stdout_lines }}"
  when: amzn_cis_rule_5_4_1_2
  tags:
    - level-1
    - section-5
    - "5.4.1.2"
    - scored



# 5.4.1.3 Ensure password expiration warning days is 7 or more

- name: 5.4.1.3 - Obtain a list of user accounts
  shell: "egrep ^[^:]+:[^\\!*] /etc/shadow | cut -d: -f1"
  register: egrep_5_4_1_3
  check_mode: no
  changed_when: False
  tags:
    - level-1
    - section-5
    - "5.4.1.3"
    - scored

- name: 5.4.1.3 - Ensure password expiration warning days is 7 or more
  lineinfile:
    dest: "/etc/login.defs"
    regexp: "^PASS_WARN_AGE\\s+"
    line: "PASS_WARN_AGE {{ cis_pass_warn_age }}"
  when: amzn_cis_rule_5_4_1_3
  tags:
    - level-1
    - section-5
    - "5.4.1.3"
    - scored

- name: 5.4.1.3 - Set password expiration warning for all user accounts
  command: "chage --warndays {{ cis_pass_warn_age }} {{ item }}"
  with_items: "{{ egrep_5_4_1_3.stdout_lines }}"
  when: amzn_cis_rule_5_4_1_3
  tags:
    - level-1
    - section-5
    - "5.4.1.3"
    - scored



# 5.4.1.4 Ensure inactive password lock is 30 days or less

- name: 5.4.1.4 - Obtain a list of user accounts
  shell: "egrep ^[^:]+:[^\\!*] /etc/shadow | cut -d: -f1"
  register: egrep_5_4_1_4
  check_mode: no
  changed_when: False
  tags:
    - level-1
    - section-5
    - "5.4.1.4"
    - scored

- name: 5.4.1.4 - Ensure inactive password lock is 30 days or less
  lineinfile:
    dest: "/etc/default/useradd"
    regexp: "^INACTIVE\\s+"
    line: "INACTIVE={{ cis_pass_inactive_lock }}"
  when: amzn_cis_rule_5_4_1_4
  tags:
    - level-1
    - section-5
    - "5.4.1.4"
    - scored

- name: 5.4.1.4 - Set inactive password lock for all user accounts
  command: "chage --inactive {{ cis_pass_inactive_lock }} {{ item }}"
  with_items: "{{ egrep_5_4_1_4.stdout_lines }}"
  when: amzn_cis_rule_5_4_1_4
  tags:
    - level-1
    - section-5
    - "5.4.1.4"
    - scored



# 5.4.2 Ensure system accounts are non-login

- name: 5.4.2 - Retrieve system accounts
  shell: "awk -F: '($3 < 500) {print $1 }' /etc/passwd | grep -v ^#"
  register: audit_5_4_2
  check_mode: no
  changed_when: False
  tags:
    - level-1
    - section-5
    - "5.4.2"
    - scored

- name: 5.4.2 - Lock system user passwords
  command: "usermod -L {{ item }}"
  with_items: "{{ audit_5_4_2.stdout_lines }}"
  when: (item != "root") and amzn_cis_rule_5_4_2
  tags:
    - level-1
    - section-5
    - "5.4.2"
    - scored

- name: 5.4.2 - Ensure system accounts are non-login
  user:
    name: "{{ item }}"
    shell: "/sbin/nologin"
  with_items: "{{ audit_5_4_2.stdout_lines }}"
  when: ("item not in cis_skip_lock_users") and amzn_cis_rule_5_4_2
  tags:
    - level-1
    - section-5
    - "5.4.2"
    - scored



# 5.4.3 Ensure default group for the root account is GID 0

- name: 5.4.3 - Check the GID of the root group
  shell: "cat /etc/passwd | awk -F: '($3 == 0) { print $1 }'"
  register: cat_5_4_3
  check_mode: no
  changed_when: False
  tags:
    - level-1
    - section-5
    - "5.4.3"
    - scored

- name: 5.4.3 - Ensure default group for the root account is GID 0
  command: usermod -g 0 root
  when: (cat_5_4_3.stdout is not defined or cat_5_4_3.stdout != 0) and amzn_cis_rule_5_4_3
  tags:
    - level-1
    - section-5
    - "5.4.3"
    - scored



# 5.4.4 Ensure default user umask is 027 or more restrictive

- name: 5.4.4 - Ensure default user umask is 027 or more restrictive
  lineinfile:
    regexp: "^umask\\s+"
    line: "umask {{ cis_umask_default }}"
    dest: "{{ item }}"
  with_items: "{{ cis_umask_shell_files }}"
  when: amzn_cis_rule_5_4_4
  tags:
    - level-1
    - section-5
    - "5.4.4"
    - scored



# 5.5 Ensure access to the su command is restricted

- name: 5.5 - Ensure access to the su command is restricted
  lineinfile:
    regexp: "^auth\\s.*\\spam_wheel.so\\s"
    line: "auth required pam_wheel.so use_uid"
    dest: "/etc/pam.d/su"
  when: amzn_cis_rule_5_5
  tags:
    - level-1
    - section-5
    - "5.5"
    - scored

- name: 5.5 - Configure wheel group members who can access the su command
  lineinfile:
    regexp: "^wheel:"
    line: "wheel:x:10:{{ cis_wheel_group_members }}"
    dest: "/etc/group"
  when: amzn_cis_rule_5_5
  tags:
    - level-1
    - section-5
    - "5.5"
    - scored
